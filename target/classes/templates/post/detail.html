<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${post.title} + ' - Discussion Forum'">Post Title - Discussion Forum</title>
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom Forum-style CSS - MUST load last to override Bootstrap -->
    <link rel="stylesheet" th:href="@{/css/forum-style.css?v=4}">
    
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf?.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" th:if="${_csrf}"/>
</head>
<body>

<!-- Header -->
<header class="forum-header">
    <div class="header-content">
        <a th:href="@{/}" class="logo">
            <i class="fas fa-comments"></i> DiscussionForum
        </a>
        
        <!-- Mobile menu toggle -->
        <button class="mobile-menu-toggle d-md-none" type="button" onclick="toggleMobileMenu()">
            <span class="hamburger"></span>
            <span class="hamburger"></span>
            <span class="hamburger"></span>
        </button>
        
        <nav class="header-nav d-none d-md-flex">
            <a th:href="@{/}" class="nav-link">
                <i class="fas fa-home"></i> Home
            </a>
            <a th:href="@{/search}" class="nav-link">
                <i class="fas fa-search"></i> Search
            </a>
            <!-- Create Post - visible for all users -->
            <a th:href="@{/posts/new}" sec:authorize="isAuthenticated()" class="nav-link">
                <i class="fas fa-plus"></i> Create Post
            </a>
            <a th:href="@{/login}" sec:authorize="!isAuthenticated()" class="nav-link">
                <i class="fas fa-plus"></i> Create Post
            </a>
            <!-- My Communities Dropdown - visible for all users -->
            <div class="dropdown" sec:authorize="isAuthenticated()" th:if="${joinedCommunities != null && !#lists.isEmpty(joinedCommunities)}">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-heart"></i> My Communities
                </a>
                <ul class="dropdown-menu">
                    <li th:each="community : ${joinedCommunities}">
                        <a class="dropdown-item" th:href="@{'/c/' + ${community.name}}">
                            <strong th:text="${community.name}">community</strong>
                            <small class="text-muted d-block" th:if="${community.description}" 
                                   th:text="${#strings.abbreviate(community.description, 40)}">
                                Description
                            </small>
                        </a>
                    </li>
                </ul>
            </div>
            <a th:href="@{/login}" sec:authorize="!isAuthenticated()" class="nav-link">
                <i class="fas fa-heart"></i> My Communities
            </a>
            <!-- Saved Posts Link - visible for all users -->
            <a th:href="@{/saved}" sec:authorize="isAuthenticated()" class="nav-link">
                <i class="fas fa-bookmark"></i> Saved Posts
            </a>
            <a th:href="@{/login}" sec:authorize="!isAuthenticated()" class="nav-link">
                <i class="fas fa-bookmark"></i> Saved Posts
            </a>
        </nav>
        
        <div class="user-menu">
            <div sec:authorize="isAuthenticated()">
                <span class="me-2" sec:authentication="name">Username</span>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
            <div sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}" class="btn btn-sm btn-outline-primary me-2">
                    <i class="fas fa-sign-in-alt"></i> Login
                </a>
                <a th:href="@{/register}" class="btn btn-sm btn-primary">
                    <i class="fas fa-user-plus"></i> Sign Up
                </a>
            </div>
        </div>
    </div>
</header>

<!-- Mobile Navigation Menu -->
<div class="mobile-nav d-md-none" id="mobileNav">
    <nav class="mobile-nav-content">
        <a th:href="@{/}" class="mobile-nav-link">
            <i class="fas fa-home"></i> Home
        </a>
        
        <a th:href="@{/search}" class="mobile-nav-link">
            <i class="fas fa-search"></i> Search
        </a>
        
        <!-- Mobile Create Post - visible for all users -->
        <a th:href="@{/posts/new}" sec:authorize="isAuthenticated()" class="mobile-nav-link">
            <i class="fas fa-plus"></i> Create Post
        </a>
        <a th:href="@{/login}" sec:authorize="!isAuthenticated()" class="mobile-nav-link">
            <i class="fas fa-plus"></i> Create Post
        </a>
        
        <!-- Mobile Saved Posts - visible for all users -->
        <a th:href="@{/saved}" sec:authorize="isAuthenticated()" class="mobile-nav-link">
            <i class="fas fa-bookmark"></i> Saved Posts
        </a>
        <a th:href="@{/login}" sec:authorize="!isAuthenticated()" class="mobile-nav-link">
            <i class="fas fa-bookmark"></i> Saved Posts
        </a>
        
        <!-- Mobile Communities - visible for all users -->
        <div sec:authorize="isAuthenticated()" th:if="${joinedCommunities != null && !#lists.isEmpty(joinedCommunities)}">
            <hr class="mobile-nav-divider">
            <div class="mobile-nav-section">My Communities</div>
            <div th:each="community : ${joinedCommunities}">
                <a class="mobile-nav-link" th:href="@{'/c/' + ${community.name}}">
                    <strong th:text="${community.name}">community</strong>
                </a>
            </div>
        </div>
        
        <!-- My Communities link for non-authenticated users -->
        <div sec:authorize="!isAuthenticated()">
            <hr class="mobile-nav-divider">
            <a th:href="@{/login}" class="mobile-nav-link">
                <i class="fas fa-heart"></i> My Communities
            </a>
        </div>
        
        <hr class="mobile-nav-divider">
        
        <!-- Auth buttons for mobile -->
        <div sec:authorize="!isAuthenticated()">
            <a th:href="@{/login}" class="mobile-nav-link">
                <i class="fas fa-sign-in-alt"></i> Login
            </a>
            <a th:href="@{/register}" class="mobile-nav-link">
                <i class="fas fa-user-plus"></i> Sign Up
            </a>
        </div>
        
        <div sec:authorize="isAuthenticated()">
            <form th:action="@{/logout}" method="post" class="mobile-logout-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                <button type="submit" class="mobile-nav-link logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>
    </nav>
</div>

<div class="main-container">
    <main class="content-area">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a th:href="@{/}">
                    <i class="fas fa-home"></i> Home
                </a>
            </li>
            <li class="breadcrumb-item">
                <a th:href="@{'/c/' + ${post.community.name}}">
                    <span th:text="${post.community.name}">community</span>
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Post</li>
        </ol>
    </nav>

    <!-- Post Detail Card -->
    <div class="post-card mb-4">
        <div class="post-content">
            <!-- Vote Section for Authenticated Users -->
            <div class="vote-section authenticated-vote" sec:authorize="isAuthenticated()">
                <form th:action="@{'/posts/' + ${post.id} + '/upvote'}" method="post" style="margin: 0;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                    <button type="submit" class="vote-btn upvote" title="Upvote">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </form>
                
                <div class="vote-score" th:text="${post.score}">42</div>
                
                <form th:action="@{'/posts/' + ${post.id} + '/downvote'}" method="post" style="margin: 0;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                    <button type="submit" class="vote-btn downvote" title="Downvote">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </form>
            </div>
            
            <!-- Vote Section for Non-authenticated Users -->
            <div class="vote-section unauthenticated-vote" sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}" class="vote-btn upvote" title="Login to vote">
                    <i class="fas fa-arrow-up"></i>
                </a>
                <div class="vote-score" th:text="${post.score}">42</div>
                <a th:href="@{/login}" class="vote-btn downvote" title="Login to vote">
                    <i class="fas fa-arrow-down"></i>
                </a>
            </div>
            
            <!-- Post Body -->
            <div class="post-body">
                <!-- Post Meta -->
                <div class="post-meta mb-2">
                    <a th:href="@{'/c/' + ${post.community.name}}" class="community-link">
                        <span th:text="${post.community.name}">community</span>
                    </a>
                    <span class="text-muted">•</span>
                    <span class="user-link" th:text="'u/' + (${post.author.displayName} ?: ${post.author.username})">
                        u/username
                    </span>
                    <span class="text-muted">•</span>
                    <span class="text-muted" th:text="${#temporals.format(post.createdAt, 'dd.MM.yy HH:mm')}">
                        25.12.24 14:30
                    </span>
                </div>
                
                <!-- Post Title -->
                <h1 class="post-title mb-3" th:text="${post.title}">
                    Amazing post title that might be quite long and should wrap properly on mobile devices
                </h1>
                
                <!-- Post Content -->
                <div class="post-full-content mb-3">
                    <p th:text="${post.content}" style="white-space: pre-wrap; line-height: 1.6;">
                        This is the full content of the post. It can be quite long and might contain multiple paragraphs.
                        
                        The content should preserve line breaks and formatting as entered by the user.
                    </p>
                </div>
                
                <!-- Post Attachments -->
                <div th:if="${post.attachmentUrls != null && !#lists.isEmpty(post.attachmentUrls)}" class="post-attachments mb-3">
                    <div class="attachments-grid">
                        <div th:each="attachmentUrl : ${post.attachmentUrls}" class="attachment-item">
                            <!-- Check if it's an image -->
                            <div th:if="${#strings.endsWith(attachmentUrl.toLowerCase(), '.jpg') || 
                                         #strings.endsWith(attachmentUrl.toLowerCase(), '.jpeg') || 
                                         #strings.endsWith(attachmentUrl.toLowerCase(), '.png') || 
                                         #strings.endsWith(attachmentUrl.toLowerCase(), '.gif') || 
                                         #strings.endsWith(attachmentUrl.toLowerCase(), '.webp') || 
                                         #strings.endsWith(attachmentUrl.toLowerCase(), '.bmp')}" 
                                 class="image-attachment">
                                <img th:src="${attachmentUrl}" th:alt="'Attachment image'" 
                                     class="img-fluid rounded" style="max-width: 100%; height: auto; max-height: 400px; cursor: pointer;"
                                     onclick="openImageModal(this.src)">
                            </div>
                            
                            <!-- Non-image files -->
                            <div th:unless="${#strings.endsWith(attachmentUrl.toLowerCase(), '.jpg') || 
                                            #strings.endsWith(attachmentUrl.toLowerCase(), '.jpeg') || 
                                            #strings.endsWith(attachmentUrl.toLowerCase(), '.png') || 
                                            #strings.endsWith(attachmentUrl.toLowerCase(), '.gif') || 
                                            #strings.endsWith(attachmentUrl.toLowerCase(), '.webp') || 
                                            #strings.endsWith(attachmentUrl.toLowerCase(), '.bmp')}" 
                                 class="document-attachment">
                                <a th:href="${attachmentUrl}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-file-alt"></i>
                                    <span th:text="${#strings.substringAfterLast(attachmentUrl, '/')}">Document</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Post Actions -->
                <div class="post-actions">
                    <span class="post-action">
                        <i class="fas fa-comment"></i>
                        <span th:text="${totalCommentCount} + ' Comments'">12 Comments</span>
                    </span>
                    <a href="#" class="post-action">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </a>
                    <a href="#" class="post-action">
                        <i class="fas fa-bookmark"></i>
                        <span>Save</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
        <div class="p-3 border-bottom bg-light">
            <h3 class="h5 mb-0">
                <i class="fas fa-comments"></i> 
                Comments (<span th:text="${totalCommentCount}">0</span>)
            </h3>
        </div>
        
        <!-- Comment Form -->
        <div class="p-3 border-bottom" sec:authorize="isAuthenticated()">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0 me-3">
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                         style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                        <span sec:authentication="name" th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</span>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <form th:action="@{'/posts/' + ${post.id} + '/comment'}" th:object="${comment}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                        <div class="mb-3">
                            <textarea th:field="*{content}" class="form-control" rows="3" 
                                      placeholder="What are your thoughts?" required></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-comment"></i> Comment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Login prompt for non-authenticated users -->
        <div class="p-3 border-bottom text-center" sec:authorize="!isAuthenticated()">
            <p class="text-muted mb-2">
                <i class="fas fa-lock"></i> 
                Log in to join the conversation
            </p>
            <a th:href="@{/login}" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-sign-in-alt"></i> Login
            </a>
            <a th:href="@{/register}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-user-plus"></i> Sign Up
            </a>
        </div>

        <!-- Comments List -->
        <div th:if="${#lists.isEmpty(comments)}" class="p-4 text-center">
            <div class="mb-3">
                <i class="fas fa-comments fa-2x text-muted"></i>
            </div>
            <h4 class="text-muted">No comments yet</h4>
            <p class="text-muted">Be the first to share what you think!</p>
        </div>
        
        <div th:each="comment, iterStat : ${comments}" class="comment" 
             th:classappend="${iterStat.last} ? 'border-bottom-0'">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0 me-3">
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" 
                         style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                        <span th:text="${#strings.substring((comment.author.displayName ?: comment.author.username), 0, 1).toUpperCase()}">U</span>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <div class="comment-meta mb-2">
                        <span class="comment-author fw-bold" 
                              th:text="'u/' + (${comment.author.displayName} ?: ${comment.author.username})">
                            u/username
                        </span>
                        <span class="text-muted mx-1">•</span>
                        <span class="text-muted" th:text="${#temporals.format(comment.createdAt, 'dd.MM.yy HH:mm')}">
                            25.12.24 14:30
                        </span>
                    </div>
                    <div class="comment-content mb-2" style="line-height: 1.5;">
                        <p th:text="${comment.content}" style="white-space: pre-wrap; margin-bottom: 0;">
                            This is a comment with some content that might span multiple lines.
                        </p>
                    </div>
                    <div class="comment-actions d-flex align-items-center">
                        <!-- Vote Section for Authenticated Users -->
                        <div sec:authorize="isAuthenticated()" class="d-flex align-items-center me-3">
                            <button class="btn btn-link btn-sm p-0 me-1 text-muted comment-vote-btn" 
                                    th:data-post-id="${post.id}"
                                    th:data-comment-id="${comment.id}"
                                    data-vote-type="upvote"
                                    style="cursor: pointer; z-index: 1000;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <span class="comment-score mx-1" th:text="${comment.score}">0</span>
                            <button class="btn btn-link btn-sm p-0 ms-1 text-muted comment-vote-btn" 
                                    th:data-post-id="${post.id}"
                                    th:data-comment-id="${comment.id}"
                                    data-vote-type="downvote"
                                    style="cursor: pointer; z-index: 1000;">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                        
                        <!-- Vote Section for Non-authenticated Users -->
                        <div sec:authorize="!isAuthenticated()" class="d-flex align-items-center me-3">
                            <a th:href="@{/login}" class="btn btn-link btn-sm p-0 me-1 text-muted">
                                <i class="fas fa-arrow-up"></i>
                            </a>
                            <span class="comment-score mx-1" th:text="${comment.score}">0</span>
                            <a th:href="@{/login}" class="btn btn-link btn-sm p-0 ms-1 text-muted">
                                <i class="fas fa-arrow-down"></i>
                            </a>
                        </div>
                        
                        <button class="btn btn-link btn-sm p-0 me-3 text-muted reply-btn" 
                                sec:authorize="isAuthenticated()" 
                                th:data-comment-id="${comment.id}"
                                style="cursor: pointer; z-index: 1000;">
                            <i class="fas fa-reply"></i> <span class="small">Reply</span>
                        </button>
                        <a th:href="@{/login}" sec:authorize="!isAuthenticated()" 
                           class="btn btn-link btn-sm p-0 me-3 text-muted">
                            <i class="fas fa-reply"></i> <span class="small">Reply</span>
                        </a>
                    </div>
                    
                    <!-- Reply Form (Initially Hidden) -->
                    <div th:id="'reply-form-' + ${comment.id}" class="reply-form mt-3" style="display: none;" sec:authorize="isAuthenticated()">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                     style="width: 28px; height: 28px; font-size: 12px; font-weight: bold;">
                                    <span sec:authentication="name" th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</span>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <form th:action="@{'/posts/' + ${post.id} + '/comments/' + ${comment.id} + '/reply'}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                                    <div class="mb-2">
                                        <textarea name="content" class="form-control form-control-sm" rows="2" 
                                                  placeholder="Write a reply..." required></textarea>
                                    </div>
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-sm btn-secondary me-2" 
                                                th:onclick="'toggleReplyForm(' + ${comment.id} + ')'">Cancel</button>
                                        <button type="submit" class="btn btn-sm btn-primary">
                                            <i class="fas fa-reply"></i> Reply
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Display Replies Recursively -->
                    <div th:if="${comment.replies != null && !comment.replies.isEmpty()}" class="replies mt-3">
                        <div th:each="reply : ${comment.replies}">
                            <div th:replace="~{post/detail :: reply-recursive(reply=${reply}, post=${post}, depth=1)}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Posts (Optional) -->
    <div class="mt-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="h6 mb-0 me-2">More from <span th:text="${post.community.name}">community</span></h4>
            <a th:href="@{'/c/' + ${post.community.name}}" class="btn btn-outline-primary btn-sm">
                View Community
            </a>
        </div>
    </div>
    </main>
    
    <aside class="sidebar d-none d-xl-block">
        <div th:replace="~{fragments/layout :: sidebar}"></div>
    </aside>
</div>

<!-- Recursive Reply Fragment -->
<div th:fragment="reply-recursive(reply, post, depth)" th:if="${reply != null}">
    <div th:class="'reply ms-4 border-start border-2 ps-3 mb-2 reply-depth-' + ${depth ?: 1}"
         th:style="|border-color: ${(depth ?: 1) <= 3 ? '#e5e7eb' : '#f3f4f6'} !important;|">
        <div class="d-flex align-items-start">
            <div class="flex-shrink-0" th:style="|margin-right: ${(depth ?: 1) <= 3 ? '12px' : '8px'};|">
                <div class="rounded-circle text-white d-flex align-items-center justify-content-center" 
                     th:class="${(depth ?: 1) == 1 ? 'bg-secondary' : ((depth ?: 1) == 2 ? 'bg-info' : ((depth ?: 1) == 3 ? 'bg-warning' : 'bg-success'))}"
                     th:style="|width: ${32 - (depth ?: 1) * 2}px; height: ${32 - (depth ?: 1) * 2}px; font-size: ${12 - (depth ?: 1) / 2}px; font-weight: bold;|">
                    <span th:text="${reply != null ? #strings.substring((reply.author?.displayName ?: reply.author?.username ?: 'U'), 0, 1).toUpperCase() : 'U'}">U</span>
                </div>
            </div>
            <div class="flex-grow-1">
                <div class="comment-meta mb-2">
                    <span class="comment-author fw-bold" 
                          th:style="|font-size: ${14 - (depth ?: 1) / 2}px;|"
                          th:text="'u/' + ${reply != null and reply.author != null ? (reply.author.displayName ?: reply.author.username ?: 'unknown') : 'unknown'}">
                        u/username
                    </span>
                    <span class="text-muted mx-1" th:style="|font-size: ${12 - (depth ?: 1) / 2}px;|">•</span>
                    <span class="text-muted" th:style="|font-size: ${12 - (depth ?: 1) / 2}px;|" 
                          th:text="${reply?.createdAt != null ? #temporals.format(reply.createdAt, (depth ?: 1) > 3 ? 'MMM d, HH:mm' : 'MMM d, yyyy HH:mm') : 'unknown'}">
                        1 hour ago
                    </span>
                </div>
                <div class="comment-content mb-2" th:style="|line-height: 1.4; font-size: ${14 - (depth ?: 1) / 2}px;|">
                    <p th:text="${reply?.content ?: 'No content'}" style="white-space: pre-wrap; margin-bottom: 0;">
                        This is a reply.
                    </p>
                </div>
                <div class="comment-actions d-flex align-items-center">
                    <!-- Vote Section for Authenticated Users -->
                    <div sec:authorize="isAuthenticated()" class="d-flex align-items-center me-3">
                        <button class="btn btn-link btn-sm p-0 me-1 text-muted comment-vote-btn" 
                                th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|"
                                th:data-post-id="${post.id}"
                                th:data-comment-id="${reply?.id ?: 0}"
                                data-vote-type="upvote">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <span class="comment-score mx-1" 
                              th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|" 
                              th:text="${reply?.score ?: 0}">0</span>
                        <button class="btn btn-link btn-sm p-0 ms-1 text-muted comment-vote-btn" 
                                th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|"
                                th:data-post-id="${post.id}"
                                th:data-comment-id="${reply?.id ?: 0}"
                                data-vote-type="downvote">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    
                    <!-- Vote Section for Non-authenticated Users -->
                    <div sec:authorize="!isAuthenticated()" class="d-flex align-items-center me-3">
                        <a th:href="@{/login}" class="btn btn-link btn-sm p-0 me-1 text-muted" 
                           th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|">
                            <i class="fas fa-arrow-up"></i>
                        </a>
                        <span class="comment-score mx-1" 
                              th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|" 
                              th:text="${reply?.score ?: 0}">0</span>
                        <a th:href="@{/login}" class="btn btn-link btn-sm p-0 ms-1 text-muted" 
                           th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|">
                            <i class="fas fa-arrow-down"></i>
                        </a>
                    </div>
                    
                    <!-- Reply Button -->
                    <button class="btn btn-link btn-sm p-0 me-3 text-muted reply-btn" 
                            sec:authorize="isAuthenticated()" 
                            th:data-comment-id="${reply?.id ?: 0}"
                            th:style="|cursor: pointer; z-index: 1000; font-size: ${11 - (depth ?: 1) / 2}px;|">
                        <i class="fas fa-reply"></i> <span class="small">Reply</span>
                    </button>
                    <a th:href="@{/login}" sec:authorize="!isAuthenticated()" 
                       class="btn btn-link btn-sm p-0 me-3 text-muted"
                       th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|">
                        <i class="fas fa-reply"></i> <span class="small">Reply</span>
                    </a>
                    
                    <!-- Collapse/Expand button for deeply nested replies -->
                    <button th:if="${(depth ?: 1) >= 2 && reply?.replies != null && !reply.replies.isEmpty()}" 
                            type="button" 
                            class="btn btn-link btn-sm p-0 text-muted collapse-toggle-btn"
                            th:onclick="|toggleNestedReplies('nested-replies-${reply?.id ?: 0}')|"
                            th:style="|font-size: ${11 - (depth ?: 1) / 2}px;|">
                        <i class="fas fa-chevron-down collapse-icon"></i> <span class="small">Show replies</span>
                    </button>
                </div>
                
                <!-- Reply Form -->
                <div th:id="'reply-form-' + ${reply?.id ?: 0}" class="reply-form mt-3" style="display: none;" sec:authorize="isAuthenticated()">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0" th:style="|margin-right: ${(depth ?: 1) <= 3 ? '12px' : '8px'};|">
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                 th:style="|width: ${30 - (depth ?: 1) * 2}px; height: ${30 - (depth ?: 1) * 2}px; font-size: ${10 - (depth ?: 1) / 2}px; font-weight: bold;|">
                                <span sec:authentication="name" th:text="${#strings.substring(#authentication.name, 0, 1).toUpperCase()}">U</span>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <form th:action="@{'/posts/' + ${post.id} + '/comments/' + ${reply?.id ?: 0} + '/reply'}" method="post">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                                <div class="mb-2">
                                    <textarea name="content" class="form-control form-control-sm" rows="2" 
                                              placeholder="Write a reply..." required 
                                              th:style="|font-size: ${13 - (depth ?: 1) / 2}px;|"></textarea>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-sm btn-secondary me-2" 
                                            th:onclick="'toggleReplyForm(' + ${reply?.id ?: 0} + ')'">Cancel</button>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Recursive Nested Replies -->
                <div th:if="${reply?.replies != null && !reply.replies.isEmpty()}" 
                     class="nested-replies mt-3" 
                     th:id="'nested-replies-' + ${reply?.id ?: 0}"
                     th:style="${(depth ?: 1) >= 2 ? 'display: none;' : ''}">
                    <div th:each="nestedReply : ${reply.replies}">
                        <div th:replace="~{post/detail :: reply-recursive(reply=${nestedReply}, post=${post}, depth=${(depth ?: 1) + 1})}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS -->
<script th:src="@{/js/app.js}"></script>

<script>
</script>

<!-- Include Create Community Modal -->
<div th:replace="~{fragments/layout :: create-community-modal}" sec:authorize="isAuthenticated()"></div>

<!-- Image Modal for viewing full-size images -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid" alt="Full size image">
      </div>
    </div>
  </div>
</div>

<style>
.post-attachments .attachments-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 15px;
}

.post-attachments .attachment-item {
    flex: 0 0 auto;
}

.post-attachments .image-attachment img {
    border: 1px solid #e0e0e0;
    transition: transform 0.2s ease;
}

.post-attachments .image-attachment img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.post-attachments .document-attachment .btn {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}
</style>

<script>
function openImageModal(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}
</script>

</body>
</html>