<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Post - Discussion Forum</title>
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom Forum-style CSS - MUST load last to override Bootstrap -->
    <link rel="stylesheet" th:href="@{/css/forum-style.css?v=3}">
    
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf?.token}" th:if="${_csrf}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" th:if="${_csrf}"/>
</head>
<body>

<!-- Header -->
<header class="forum-header">
    <div class="header-content">
        <a th:href="@{/}" class="logo">
            <i class="fas fa-comments"></i> DiscussionForum
        </a>
        
        <nav class="header-nav d-none d-md-flex">
            <a th:href="@{/}" class="nav-link">
                <i class="fas fa-home"></i> Home
            </a>
            <a th:href="@{/search}" class="nav-link">
                <i class="fas fa-search"></i> Search
            </a>
            <a th:href="@{/posts/new}" sec:authorize="isAuthenticated()" class="nav-link">
                <i class="fas fa-plus"></i> Create Post
            </a>
            <!-- My Communities Dropdown -->
            <div class="dropdown" sec:authorize="isAuthenticated()" th:if="${joinedCommunities != null && !#lists.isEmpty(joinedCommunities)}">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-heart"></i> My Communities
                </a>
                <ul class="dropdown-menu">
                    <li th:each="community : ${joinedCommunities}">
                        <a class="dropdown-item" th:href="@{'/c/' + ${community.name}}">
                            <strong th:text="${community.name}">community</strong>
                            <small class="text-muted d-block" th:if="${community.description}" 
                                   th:text="${#strings.abbreviate(community.description, 40)}">
                                Description
                            </small>
                        </a>
                    </li>
                </ul>
            </div>
            <!-- Saved Posts Link -->
            <a th:href="@{/saved}" sec:authorize="isAuthenticated()" class="nav-link">
                <i class="fas fa-bookmark"></i> Saved Posts
            </a>
        </nav>
        
        <div class="user-menu">
            <div sec:authorize="isAuthenticated()">
                <span class="me-2" sec:authentication="name">Username</span>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
            <div sec:authorize="!isAuthenticated()">
                <a th:href="@{/login}" class="btn btn-sm btn-outline-primary me-2">
                    <i class="fas fa-sign-in-alt"></i> Login
                </a>
                <a th:href="@{/register}" class="btn btn-sm btn-primary">
                    <i class="fas fa-user-plus"></i> Sign Up
                </a>
            </div>
        </div>
    </div>
</header>

<div class="main-container">
    <main class="content-area">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a th:href="@{/}">
                    <i class="fas fa-home"></i> Home
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Create Post</li>
        </ol>
    </nav>

    <!-- Create Post Header -->
    <div class="d-flex align-items-center mb-4">
        <i class="fas fa-edit fa-2x text-primary me-3"></i>
        <div>
            <h1 class="h3 mb-1">Create a new post</h1>
            <p class="text-muted mb-0">Share your thoughts with the community</p>
        </div>
    </div>

    <!-- Create Post Form -->
    <div class="post-card">
        <div class="p-4">
            <form th:action="@{/posts}" th:object="${post}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>
                
                <!-- Community Selection -->
                <div class="mb-4">
                    <label for="communitySelect" class="form-label">
                        <i class="fas fa-users"></i> Choose a community
                    </label>
                    <select class="form-select" id="communitySelect" th:field="*{communityId}" required>
                        <option value="">Select a community...</option>
                        <option th:each="community : ${communities}" 
                                th:value="${community.id}" 
                                th:text="${community.name} + (${community.description} ? ' - ' + ${#strings.abbreviate(community.description, 50)} : '')"
                                th:selected="${param.community != null and param.community == community.name}">
                            community - Description
                        </option>
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i> 
                        Can't find your community? 
                        <a href="#" data-bs-toggle="modal" data-bs-target="#createCommunityModal">Create a new one</a>
                    </div>
                </div>

                <!-- Post Title -->
                <div class="mb-4">
                    <label for="postTitle" class="form-label">
                        <i class="fas fa-heading"></i> Title
                    </label>
                    <input type="text" class="form-control form-control-lg" id="postTitle" 
                           th:field="*{title}" placeholder="An interesting title..." 
                           maxlength="300" required>
                    <div class="form-text">
                        <span class="text-muted">Make it descriptive and engaging</span>
                        <span class="float-end">
                            <span id="titleCounter">0</span>/300
                        </span>
                    </div>
                </div>

                <!-- Post Content -->
                <div class="mb-4" id="textContent">
                    <label for="postContent" class="form-label">
                        <i class="fas fa-edit"></i> Content
                    </label>
                    <textarea class="form-control" id="postContent" th:field="*{content}" 
                              rows="6" placeholder="What's on your mind?" required></textarea>
                    <div class="form-text">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-info-circle"></i> 
                                Share your thoughts, ask questions, or start a discussion
                            </div>
                            <div class="text-muted">
                                <span id="contentCounter">0</span> characters
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="mb-4">
                    <label class="form-label">
                        <i class="fas fa-paperclip"></i> Attachments (Optional)
                    </label>
                    <input type="file" class="form-control" id="attachmentFiles" name="attachmentFiles" multiple 
                           accept=".jpg,.jpeg,.png,.gif,.webp,.bmp,.pdf,.doc,.docx,.txt,.md,.rtf">
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i> 
                        You can upload images (max 2MB each) or documents (max 10MB each). Multiple files allowed.
                    </div>
                    <div id="attachmentPreview" class="mt-2"></div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        <i class="fas fa-info-circle"></i> 
                        Remember to follow community guidelines
                    </div>
                    <div>
                        <a th:href="@{/}" class="btn btn-secondary me-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Post
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Posting Guidelines Sidebar -->
    <div class="mt-4">
        <div class="post-card">
            <div class="p-3">
                <h4 class="h6 mb-3">
                    <i class="fas fa-lightbulb text-warning"></i> Posting Guidelines
                </h4>
                <ul class="small text-muted mb-0 ps-3">
                    <li class="mb-2">Choose a clear, descriptive title</li>
                    <li class="mb-2">Select the most appropriate community</li>
                    <li class="mb-2">Be respectful and constructive</li>
                    <li class="mb-2">Search before posting to avoid duplicates</li>
                    <li class="mb-2">Follow community-specific rules</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Include Create Community Modal -->
    <div th:replace="~{fragments/layout :: create-community-modal}"></div>
    </main>
    
    <aside class="sidebar d-none d-xl-block">
        <div th:replace="~{fragments/layout :: sidebar}"></div>
    </aside>
</div>

<!-- Custom JavaScript for Post Creation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counters
    const titleInput = document.getElementById('postTitle');
    const contentInput = document.getElementById('postContent');
    const titleCounter = document.getElementById('titleCounter');
    const contentCounter = document.getElementById('contentCounter');
    
    if (titleInput && titleCounter) {
        titleInput.addEventListener('input', function() {
            titleCounter.textContent = this.value.length;
        });
    }
    
    if (contentInput && contentCounter) {
        contentInput.addEventListener('input', function() {
            contentCounter.textContent = this.value.length;
        });
    }

    // File upload handling
    const fileInput = document.getElementById('attachmentFiles');
    const previewDiv = document.getElementById('attachmentPreview');
    const form = document.querySelector('form');
    let selectedFiles = [];

    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            updateFilePreview();
        });
    }

    function updateFilePreview() {
        previewDiv.innerHTML = '';
        
        if (selectedFiles.length === 0) return;
        
        const filesDiv = document.createElement('div');
        filesDiv.className = 'selected-files mt-2';
        
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item d-flex align-items-center justify-content-between p-2 border rounded mb-1';
            
            const fileInfo = document.createElement('span');
            fileInfo.className = 'file-info';
            fileInfo.innerHTML = `<i class="fas ${getFileIcon(file.type)}"></i> ${file.name} (${formatFileSize(file.size)})`;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-outline-danger';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = () => removeFile(index);
            
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(removeBtn);
            filesDiv.appendChild(fileItem);
        });
        
        previewDiv.appendChild(filesDiv);
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFilePreview();
        
        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }

    function getFileIcon(mimeType) {
        if (mimeType.startsWith('image/')) return 'fa-image';
        if (mimeType.includes('pdf')) return 'fa-file-pdf';
        if (mimeType.includes('word')) return 'fa-file-word';
        if (mimeType.includes('text')) return 'fa-file-text';
        return 'fa-file';
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Form submission handling - files are uploaded with the form
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
                submitBtn.disabled = true;
            }
        });
    }
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JS -->
<script th:src="@{/js/app.js}"></script>

</body>
</html>